<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Là où tout a commencé…</title>

  <!-- PWA essentials -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#c0392b">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192.png">

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{--rose:#fff0f5;--rouge:#c0392b;--texte:#2c3e50;--gris:#7f8c8d;--card:#fff;--A4w:794px;--A4h:1123px}
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden}
    body{margin:0;padding:16px;background:#fafafa;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--texte)}
    img{max-width:100%;display:block}

    .wrap{max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:20px;grid-template-columns:1fr}
    .grid>*{min-width:0}
    @media(min-width:1000px){.grid{grid-template-columns:440px 1fr;gap:24px}}

    /* form */
    form{background:var(--card);padding:18px;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    label{display:block;font-weight:700;margin:12px 0 6px}
    input,select,button{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#c0392b55;box-shadow:0 0 0 3px #c0392b20}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:640px){.row{grid-template-columns:1fr}}

    /* options (accordéon) */
    .accordion-btn{margin-top:8px;background:#f3f4f6;border:1px solid #e5e7eb;color:#111;display:flex;align-items:center;justify-content:space-between}
    .accordion{display:none;margin-top:10px;padding:12px;border:1px solid #eee;border-radius:12px;background:#fafafa}
    .checks{display:grid;grid-template-columns:1fr;gap:10px 16px}
    @media(min-width:768px){.checks{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .checkline{display:flex;align-items:center;gap:10px;margin:0;font-size:15px;cursor:pointer}
    .checkline input{transform:scale(1.1);accent-color:var(--rouge)}

    /* preview */

    #preview{width:100%;background:var(--rose);border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.10);position:relative;overflow:hidden}
    /* assure les fonds/teintes dans le rendu */
    #preview { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    
    .corner-deco{position:absolute;opacity:.10;pointer-events:none;width:360px;height:360px;right:-100px;top:-100px;background:radial-gradient(circle,#e63946 40%,transparent 41%);filter:blur(26px)}
    .title{font-family:'Dancing Script',cursive;font-size:36px;color:var(--rouge);text-align:center;margin:0 0 12px}
    .names{text-align:center;font-size:22px;margin:2px 0 4px;font-weight:700}
    .meta{text-align:center;color:var(--gris);margin:2px 0;min-height:1.2em;overflow-wrap:anywhere}

    #mapframe{position:relative;background:#fff;border-radius:16px;padding:10px;box-shadow:0 8px 22px rgba(0,0,0,.12);margin-top:16px}
    #mapimg{width:100%;height:auto;border-radius:12px;min-height:240px;aspect-ratio:11/6}
    #marker{position:absolute;left:50%;top:50%;width:clamp(26px,6vw,34px);height:clamp(26px,6vw,34px);transform:translate(-50%,-50%);pointer-events:none;filter:drop-shadow(0 1px 1.5px rgba(0,0,0,.35));display:block}

    .map-controls{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .map-controls button{width:auto;padding:8px 10px;border-radius:10px;background:#f3f4f6;border:1px solid #e5e7eb}
    .map-controls .arrows{display:grid;grid-template-columns:36px 36px 36px;gap:4px}
    .map-controls .arrows button{height:36px}

    button.primary{background:var(--rouge);color:#fff;border:none;margin-top:14px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <form id="f" autocomplete="on">
      <div class="row">
        <div>
          <label for="p1">Prénom 1</label>
          <input id="p1" placeholder="Jacquie" />
        </div>
        <div>
          <label for="p2">Prénom 2</label>
          <input id="p2" placeholder="Michel" />
        </div>
      </div>

      <label>Adresse (rue et n°)</label>
      <input id="street" placeholder="35 Rue du Chevalier de la Barre" autocomplete="address-line1" />

      <div class="row">
        <div>
          <label>Code postal</label>
          <input id="postal" placeholder="75018" inputmode="numeric" autocomplete="postal-code" />
        </div>
        <div>
          <label>Ville</label>
          <input id="city" placeholder="Paris" autocomplete="address-level2" />
        </div>
      </div>

      <label>Pays</label>
      <select id="country" autocomplete="country">
        <optgroup label="Populaires">
          <option selected>France</option>
          <option>Belgique</option>
          <option>Suisse</option>
          <option>Luxembourg</option>
          <option>Espagne</option>
          <option>Italie</option>
          <option>Allemagne</option>
        </optgroup>
        <optgroup label="Autres">
          <option>Portugal</option><option>Pays-Bas</option><option>Royaume-Uni</option>
          <option>États-Unis</option><option>Canada</option>
        </optgroup>
      </select>

      <button class="accordion-btn" type="button" id="optBtn">
        options d’affichage <span id="optCaret">▾</span>
      </button>
      <div class="accordion" id="optPanel">
        <div class="checks">
          <label class="checkline"><input type="checkbox" id="showDate"><span>afficher la date</span></label>
          <div id="dateRow" style="display:none">
            <label for="date" style="margin:6px 0 6px">Date (JJ/MM/AAAA)</label>
            <input id="date" placeholder="jj/mm/aaaa" inputmode="numeric" />
          </div>

          <label class="checkline"><input type="checkbox" id="showStreet" checked><span>afficher l’adresse</span></label>
          <label class="checkline"><input type="checkbox" id="showPostal" checked><span>afficher le code postal</span></label>
          <label class="checkline"><input type="checkbox" id="showCity" checked><span>afficher la ville</span></label>
          <label class="checkline"><input type="checkbox" id="showCoords" checked><span>afficher les coordonnées</span></label>

          <label style="margin-top:8px">Style du curseur</label>
          <select id="style">
            <option value="heart" selected>cœur</option>
            <option value="pin">curseur</option>
            <option value="star">étoile</option>
          </select>
        </div>
      </div>

      <button class="primary" type="button" id="dl" disabled>télécharger le PDF</button>
    </form>

    <section id="preview">
      <div class="corner-deco"></div>
      <h2 class="title">Là où tout a commencé…</h2>
      <p class="names" id="names">Jacquie & Michel</p>
      <p class="meta" id="when"></p>
      <p class="meta" id="line1"></p>
      <p class="meta" id="line2"></p>
      <p class="meta" id="line3"></p>

      <div id="mapframe">
        <img id="mapimg" alt="Plan de la rencontre">
        <img id="marker" alt="">
      </div>

      <div class="map-controls">
        <div class="arrows">
          <button type="button" data-pan="up">↑</button>
          <button type="button" data-zoom="+">＋</button>
          <button type="button" data-pan="right">→</button>
          <button type="button" data-pan="left">←</button>
          <button type="button" data-zoom="-">－</button>
          <button type="button" data-pan="down">↓</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/* ---------- icons (SVG → data URLs) ---------- */
const ICONS = {
  heart: 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e63946">
       <path d="M12 21c-4.8-3.6-8-6.9-8-10.7C4 7.3 6.2 5 9 5c1.4 0 2.7.7 3.5 1.9C13.3 5.7 14.6 5 16 5c2.8 0 5 2.3 5 5.3 0 3.8-3.2 7.1-9 10.7z"/>
     </svg>`),
  pin: 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#c0392b" stroke="white" stroke-width="1.1">
       <path d="M12 2c-3.3 0-6 2.7-6 6 0 4.6 6 12 6 12s6-7.4 6-12c0-3.3-2.7-6-6-6zm0 9.2a3.2 3.2 0 1 1 0-6.4 3.2 3.2 0 0 1 0 6.4z"/>
     </svg>`),
  star: 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f1c40f" stroke="white" stroke-width="1.1">
       <path d="M12 17.3l6.2 3.7-1.6-7 4.4-4.8-7.2-.6L12 2 10.2 8.6 3 9.2l4.4 4.8L5.8 21z"/>
     </svg>`)
};

const $ = id => document.getElementById(id);

/* ---------- accordéon ---------- */
const btn = $('optBtn'), panel = $('optPanel'), caret = $('optCaret');
btn.addEventListener('click', () => {
  const open = panel.style.display === 'block';
  panel.style.display = open ? 'none' : 'block';
  caret.textContent = open ? '▾' : '▴';
});

/* ---------- date ---------- */
const showDate = $('showDate');
const dateRow = $('dateRow');
showDate.addEventListener('change', () => {
  dateRow.style.display = showDate.checked ? 'block' : 'none';
  if (showDate.checked && !$('date').value) {
    const d = new Date(), dd = String(d.getDate()).padStart(2,'0'),
          mm = String(d.getMonth()+1).padStart(2,'0'), yy = d.getFullYear();
    $('date').value = `${dd}/${mm}/${yy}`;
  }
  renderText();
});

/* ---------- debounced geocode (structuré) + cache ---------- */
let state = {
  zoom: 15,
  lat: 48.88681, lon: 2.34302,          // Sacré-Cœur par défaut
  key: '', cache: new Map()
};

function buildKey(){
  return [ $('street').value.trim(), $('postal').value.trim(),
           $('city').value.trim(), $('country').value.trim() ].join('|').toLowerCase();
}

async function geocodeStructured(){
  const street = $('street').value.trim(),
        postal = $('postal').value.trim(),
        city   = $('city').value.trim(),
        country= $('country').value.trim();
  // on n’essaie que si au moins ville + pays sont présents
  if (!city || !country) return null;

  const key = buildKey();
  if (state.cache.has(key)) return state.cache.get(key);

  const url = `/api/geocode?street=${encodeURIComponent(street)}&postalcode=${encodeURIComponent(postal)}&city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}`;
  const r = await fetch(url);
  if (!r.ok) return null;
  const json = await r.json();
  state.cache.set(key, json);
  return json;
}

let geocodeTimer = null;
function requestGeocode(){
  const newKey = buildKey();
  if (newKey === state.key) return;            // rien n’a changé
  state.key = newKey;

  clearTimeout(geocodeTimer);
  geocodeTimer = setTimeout(async () => {
    const res = await geocodeStructured();
    if (res && res.lat && res.lon){
      state.lat = res.lat; state.lon = res.lon;
      renderMap();                             // carte vite
      renderText();                            // texte avec ville/coordonées si cochés
    }
  }, 350);
}

/* ---------- rendu texte ---------- */
function renderText(){
  const p1 = $('p1').value.trim() || 'Jacquie';
  const p2 = $('p2').value.trim() || 'Michel';
  $('names').textContent = `${p1} & ${p2}`;

  $('when').textContent = (showDate.checked && $('date').value.trim())
    ? $('date').value.trim() : '';

  const line1 = [];
  if ($('showStreet').checked) line1.push($('street').value.trim());
  $('line1').textContent = line1.join(' • ');

  const line2 = [];
  if ($('showPostal').checked) line2.push($('postal').value.trim());
  if ($('showCity').checked)   line2.push($('city').value.trim());
  $('line2').textContent = line2.filter(Boolean).join(' • ');

  $('line3').textContent = $('showCoords').checked
    ? `(${state.lat.toFixed(5)}, ${state.lon.toFixed(5)})` : '';

  // curseur
  $('marker').src = ICONS[$('style').value];
}

/* ---------- rendu carte (base64) ---------- */
async function renderMap(){
  try{
    $('dl').disabled = true;
    const r = await fetch(`/api/staticmap?lat=${state.lat}&lon=${state.lon}&zoom=${state.zoom}&w=1100&h=650`);
    const { dataUrl } = await r.json();
    $('mapimg').src = dataUrl;
  } finally {
    $('dl').disabled = false;
  }
}

/* ---------- controls zoom / pan ---------- */
function pan(deltaLat, deltaLon){
  state.lat += deltaLat;
  state.lon += deltaLon;
  renderMap();
}
document.querySelectorAll('.map-controls button').forEach(b=>{
  const z = b.dataset.zoom, p = b.dataset.pan;
  b.addEventListener('click', ()=>{
    if (z){
      state.zoom = Math.max(12, Math.min(18, state.zoom + (z==='+'?1:-1)));
      renderMap();
    } else if (p){
      // pas grand déplacement; dépend du zoom
      const step = (p==='left'||p==='right') ? (0.002 / Math.pow(2, (state.zoom-12))) : (0.0015 / Math.pow(2,(state.zoom-12)));
      if (p==='up') pan(step,0);
      if (p==='down') pan(-step,0);
      if (p==='left') pan(0,-step);
      if (p==='right') pan(0,step);
    }
  });
});

/* ---------- listeners ---------- */
['p1','p2','date','style','showStreet','showPostal','showCity','showCoords']
  .forEach(id=>$(id).addEventListener('input', ()=>{ renderText(); }));

['street','postal','city','country'].forEach(id=>{
  $(id).addEventListener('input', requestGeocode);
  $(id).addEventListener('change', requestGeocode);
});

/* ---------- initial load ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // valeurs par défaut (Sacré-Cœur)
  $('street').value = '35 Rue du Chevalier de la Barre';
  $('postal').value = '75018';
  $('city').value   = 'Paris';
  $('country').value= 'France';
  $('marker').src = ICONS.heart;

  renderText();
  renderMap();
});

/* ---------- PDF A4 (1 page) ---------- */
function waitImage(imgEl){
    return new Promise((resolve)=> {
      if (!imgEl || imgEl.complete) return resolve();
      imgEl.onload = imgEl.onerror = () => resolve();
    });
  }

  document.getElementById('dl').addEventListener('click', async () => {
    const A4W = 794;   // pt @96dpi
    const A4H = 1123;

    const el = document.getElementById('preview');

    // attendre que les polices et l’image soient prêtes
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch(e) {}
    }
    await waitImage(document.getElementById('mapimg'));

    // mise à l’échelle temporaire
    const original = {
      width: el.style.width || '',
      transform: el.style.transform || '',
      transformOrigin: el.style.transformOrigin || ''
    };
    const h = el.scrollHeight;
    const scale = h > A4H ? (A4H / h) : 1;

    el.style.transformOrigin = 'top left';
    el.style.transform = `scale(${scale})`;
    el.style.width = (A4W / scale) + 'px';

    // export PDF
    const opt = {
      margin: 0,
      filename: 'la-ou-tout-a-commence.pdf',
      image: { type: 'jpeg', quality: 1 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff', removeContainer: true },
      jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all'] }
    };

    try {
      await html2pdf().from(el).set(opt).save();
    } finally {
      el.style.width = original.width;
      el.style.transform = original.transform;
      el.style.transformOrigin = original.transformOrigin;
    }
  });

/* ---------- SW ---------- */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('/sw.js').catch(()=>{})); }
</script>
</body>
</html>
